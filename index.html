<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enterprise POS (Synced)</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b0c10; color:#eaf0ff; }
    .topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#11131a; position:sticky; top:0; z-index:10; }
    .nav { display:flex; gap:8px; }
    .navbtn { background:#1b1f2b; color:#eaf0ff; border:1px solid #2a3042; padding:10px 12px; border-radius:10px; font-weight:700; }
    .active { outline:2px solid #7aa2ff; }
    .app { padding:12px; padding-bottom:90px; }
    .hidden { display:none !important; }

    .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .pane { background:#11131a; border:1px solid #20243a; border-radius:14px; padding:12px; }
    .pane-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

    .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; max-height:72vh; overflow:auto; padding-right:4px; }
    .list { display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow:auto; padding-right:4px; }

    .tile { background:#0d0f15; border:1px solid #22263a; border-radius:12px; padding:12px; user-select:none; }
    .tile:active { outline:2px solid #7aa2ff; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .tiny { opacity:.7; font-size:12px; }

    button { touch-action: manipulation; }
    .ghost { background:transparent; color:#eaf0ff; border:1px solid #2a3042; padding:10px 12px; border-radius:12px; font-weight:800; }
    .primary { background:#7aa2ff; color:#081022; border:none; padding:12px; border-radius:12px; font-weight:900; width:100%; }
    .qtybtn { background:#1b1f2b; color:#eaf0ff; border:1px solid #2a3042; padding:8px 12px; border-radius:10px; font-weight:900; }

    input { width:100%; box-sizing:border-box; padding:12px; border-radius:12px; border:1px solid #2a3042; background:#0b0c10; color:#eaf0ff; font-size:16px; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:14px; z-index:50; }
    .modal-card { width:min(820px,100%); background:#11131a; border:1px solid #20243a; border-radius:14px; padding:14px; }
    .row2 { display:flex; gap:10px; }

    .paywrap { max-width:560px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
    .err { color:#ff8a8a; min-height:18px; }

    .mutedbox { background:#0d0f15; border:1px dashed #2a3042; border-radius:12px; padding:12px; opacity:.85; }

    .danger { background:#b00020 !important; color:#fff !important; border:none !important; }

    .statusbar { position:fixed; left:0; right:0; bottom:0; padding:10px; background:#11131a; border-top:1px solid #20243a; z-index:9999; }
    .banner { font-weight:900; }
  </style>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
</head>

<body>
  <header class="topbar">
    <div style="font-weight:900">Enterprise POS</div>
    <nav class="nav">
      <button id="nav-cashier" class="navbtn active" onclick="showView('cashier')">Cashier</button>
      <button id="nav-cook" class="navbtn" onclick="showView('cook')">Cook</button>
      <button id="nav-history" class="navbtn" onclick="showView('history')">History</button>
    </nav>
  </header>

  <main class="app">
    <!-- CASHIER -->
    <section id="view-cashier">
      <div id="cashierMain">
        <div class="split">
          <div class="pane">
            <div class="pane-head">
              <h2>Menu</h2>
              <button class="ghost" onclick="openItems()">Items ✏️</button>
            </div>
            <div id="itemsGrid" class="grid"></div>
          </div>

          <div class="pane">
            <div class="pane-head">
              <h2>Cart</h2>
              <button class="ghost" onclick="clearCart()">Clear</button>
            </div>
            <div id="cartList" class="list"></div>

            <div class="row" style="margin-top:10px;">
              <span>Total</span>
              <strong id="cartTotal">£0.00</strong>
            </div>

            <div style="margin-top:10px;">
              <button class="primary" onclick="openPay()">Pay</button>
            </div>

            <div style="margin-top:14px;">
              <h3 style="margin:0 0 10px 0;">Ready orders</h3>
              <div id="cashierReadyEmpty" class="mutedbox hidden">No ready orders yet.</div>
              <div id="cashierReadyList" class="list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pay view -->
      <div id="cashierPay" class="hidden">
        <div class="pane">
          <div class="pane-head">
            <h2>Payment</h2>
            <button class="ghost" onclick="closePay()">Back</button>
          </div>

          <div class="paywrap">
            <div class="row" style="font-size:20px;">
              <span>Amount due</span>
              <strong id="dueAmt">£0.00</strong>
            </div>

            <div>
              <div class="tiny" style="margin-bottom:6px;">Amount given</div>
              <input id="givenInput" type="number" inputmode="decimal" placeholder="0.00" oninput="updateChange()">
            </div>

            <div class="row" style="font-size:20px;">
              <span>Change</span>
              <strong id="changeAmt">£0.00</strong>
            </div>

            <div class="row2">
              <button class="ghost" onclick="closePay()">Cancel</button>
              <button class="primary" onclick="completePay()">Complete</button>
            </div>

            <div class="err" id="payErr"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- COOK -->
    <section id="view-cook" class="hidden">
      <div class="pane">
        <div class="pane-head">
          <h2>Orders (Cooking)</h2>
          <span class="tiny">Tap order to expand</span>
        </div>
        <div id="cookOrders" class="list"></div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="hidden">
      <div class="pane">
        <div class="pane-head">
          <h2>Order History (Proof)</h2>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="tiny">Tap Details</span>
            <button class="ghost danger" style="width:auto;" onclick="resetDay()">RESET DAY</button>
          </div>
        </div>
        <div id="historyList" class="list"></div>
      </div>
    </section>
  </main>

  <!-- Items Modal -->
  <div id="itemsModal" class="modal" onclick="modalBackdrop(event)">
    <div class="modal-card">
      <div class="row" style="margin-bottom:10px;">
        <h2 style="margin:0;">Items</h2>
        <button class="ghost" style="width:auto;" onclick="closeItems()">Close</button>
      </div>

      <div class="row2">
        <input id="newItemName" placeholder="Name" />
        <input id="newItemPrice" type="number" inputmode="decimal" placeholder="Price" />
      </div>
      <input id="newItemNotes" placeholder="Notes (optional)" />

      <div style="margin-top:12px;">
        <button class="primary" onclick="addItem()">Add item</button>
      </div>

      <hr style="border:none;border-top:1px solid #20243a;margin:14px 0;">
      <div id="itemsAdminList" class="list"></div>
    </div>
  </div>

  <div class="statusbar">
    <div class="banner">Status: <span id="connStatus">Booting…</span></div>
    <div class="tiny">Last: <span id="lastMsg">—</span></div>
  </div>

<script>
/***********************
 * FIREBASE CONFIG
 ***********************/
const firebaseConfig = {
  apiKey: "AIzaSyARBfapCjXLkhlmuTKT9lJRbLLAc6u0jU0",
  authDomain: "enterprise-d157a.firebaseapp.com",
  projectId: "enterprise-d157a",
  storageBucket: "enterprise-d157a.firebasestorage.app",
  messagingSenderId: "776029370493",
  appId: "1:776029370493:web:7117b4338120ac89719914",
  measurementId: "G-3FBXQ78259"
};

let db = null;
let F = null; // FieldValue

/***********************
 * LOCAL UI STATE
 ***********************/
let items = [];   // from Firestore
let orders = [];  // from Firestore

// Cart stays local to each device
const cart = new Map(); // itemId -> qty

function $(id){ return document.getElementById(id); }
function money(n){ return "£" + Number(n).toFixed(2); }
function msg(s){ $("lastMsg").textContent = s; }
function setConn(s){ $("connStatus").textContent = s; }

function showView(view){
  ["cashier","cook","history"].forEach(v => {
    $("view-"+v).classList.toggle("hidden", v !== view);
    $("nav-"+v).classList.toggle("active", v === view);
  });
  msg("Switched to " + view);
}

/***********************
 * MODAL
 ***********************/
function openItems(){
  $("itemsModal").style.display = "flex";
  renderAdmin();
  msg("Opened items editor");
}
function closeItems(){
  $("itemsModal").style.display = "none";
  msg("Closed items editor");
}
function modalBackdrop(e){
  if (e.target.id === "itemsModal") closeItems();
}

/***********************
 * ITEMS (Firestore)
 ***********************/
async function addItem(){
  if (!db) return alert("Not connected to Firebase yet.");

  const name = $("newItemName").value.trim();
  const price = Number($("newItemPrice").value);
  const notes = $("newItemNotes").value.trim();
  if (!name || !Number.isFinite(price)) { msg("Missing name/price"); return; }

  const createdAtMs = Date.now();
  await db.collection("items").add({
    name, price, notes,
    createdAtMs,
    createdAt: F.serverTimestamp()
  });

  $("newItemName").value = "";
  $("newItemPrice").value = "";
  $("newItemNotes").value = "";
  msg("Item added ✅");
}

/* ✅ FIXED delete: only uses itemId */
async function deleteItem(itemId){
  if (!db) return;

  const it = items.find(x => x.id === itemId);
  const name = it ? it.name : "this item";

  if (!confirm(`Delete "${name}"?`)) return;

  await db.collection("items").doc(itemId).delete();
  msg(`Deleted: ${name}`);
}

function renderMenu(){
  const grid = $("itemsGrid");
  grid.innerHTML = "";
  for (const it of items){
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `<div style="font-weight:900">${it.name}</div><div class="tiny">${money(it.price)}</div>`;
    tile.onclick = () => addToCart(it.id);
    grid.appendChild(tile);
  }
}

function renderAdmin(){
  const list = $("itemsAdminList");
  list.innerHTML = "";
  for (const it of items){
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <div class="row">
        <div>
          <div style="font-weight:900">${it.name}</div>
          <div class="tiny">${it.notes || ""}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div style="font-weight:900">${money(it.price)}</div>
          <button class="ghost" style="width:auto;" onclick="deleteItem('${it.id}')">Delete</button>
        </div>
      </div>
    `;
    list.appendChild(tile);
  }
}

/***********************
 * CART (local)
 ***********************/
function addToCart(itemId){
  cart.set(itemId, (cart.get(itemId) || 0) + 1);
  renderCart();
  const it = items.find(x => x.id === itemId);
  msg("Added to cart: " + (it ? it.name : itemId));
}
function incQty(itemId){
  cart.set(itemId, (cart.get(itemId) || 0) + 1);
  renderCart();
}
function decQty(itemId){
  const q = cart.get(itemId) || 0;
  if (q <= 1) cart.delete(itemId);
  else cart.set(itemId, q - 1);
  renderCart();
}
function clearCart(){
  cart.clear();
  renderCart();
  msg("Cart cleared");
}
function cartTotal(){
  let total = 0;
  for (const [itemId, qty] of cart.entries()){
    const it = items.find(x => x.id === itemId);
    if (it) total += it.price * qty;
  }
  return total;
}
function renderCart(){
  const list = $("cartList");
  list.innerHTML = "";
  let total = 0;

  for (const [itemId, qty] of cart.entries()){
    const it = items.find(x => x.id === itemId);
    if (!it) continue;
    total += it.price * qty;

    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <div class="row">
        <div>
          <div style="font-weight:900">${it.name}</div>
          <div class="tiny">${money(it.price)} each</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="qtybtn" onclick="decQty('${itemId}')">−</button>
          <strong style="min-width:26px;text-align:center;">${qty}</strong>
          <button class="qtybtn" onclick="incQty('${itemId}')">+</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <span class="tiny">Line total</span>
        <strong>${money(it.price * qty)}</strong>
      </div>
    `;
    list.appendChild(tile);
  }

  $("cartTotal").textContent = money(total);
}

/***********************
 * PAYMENT
 ***********************/
function openPay(){
  if (cart.size === 0) { msg("Cart is empty"); return; }
  $("payErr").textContent = "";
  $("givenInput").value = "";
  $("dueAmt").textContent = money(cartTotal());
  $("changeAmt").textContent = money(0);

  $("cashierMain").classList.add("hidden");
  $("cashierPay").classList.remove("hidden");
  msg("Pay opened");
}
function closePay(){
  $("cashierPay").classList.add("hidden");
  $("cashierMain").classList.remove("hidden");
  msg("Back to cashier");
}
function updateChange(){
  const due = cartTotal();
  const given = Number($("givenInput").value);
  const change = Number.isFinite(given) ? (given - due) : 0;
  $("changeAmt").textContent = money(Math.max(0, change));
}

async function completePay(){
  if (!db) return alert("Not connected to Firebase yet.");

  const due = cartTotal();
  const given = Number($("givenInput").value);

  if (!Number.isFinite(given) || given < due){
    $("payErr").textContent = "Amount given must be at least the amount due.";
    msg("Pay error");
    return;
  }

  if (!confirm("Complete payment and send order to cook?")) return;

  const lines = [];
  for (const [itemId, qty] of cart.entries()){
    const it = items.find(x => x.id === itemId);
    if (!it) continue;
    lines.push({ itemId, name: it.name, price: it.price, qty });
  }

  const createdAtMs = Date.now();

  try {
    await db.runTransaction(async (tx) => {
      const counterRef = db.collection("meta").doc("counters");
      const counterSnap = await tx.get(counterRef);
      const next = (counterSnap.exists && Number.isFinite(counterSnap.data().nextOrderNumber))
        ? counterSnap.data().nextOrderNumber
        : 1;

      tx.set(counterRef, { nextOrderNumber: next + 1 }, { merge: true });

      const orderRef = db.collection("orders").doc();
      tx.set(orderRef, {
        number: next,
        status: "COOKING",
        lines,
        total: due,
        paid: given,
        change: given - due,
        createdAtMs,
        createdAt: F.serverTimestamp(),
        readyAtMs: null,
        readyAt: null,
        pickedUpAtMs: null,
        pickedUpAt: null,
      });
    });

    cart.clear();
    renderCart();
    closePay();
    msg("Order confirmed ✅");
    alert("Order confirmed ✅");
  } catch (e) {
    console.error(e);
    $("payErr").textContent = "Could not create order (check rules / connection).";
    msg("Order create failed ❌");
  }
}

/***********************
 * ORDERS RENDERING
 ***********************/
function renderCook(){
  const list = $("cookOrders");
  list.innerHTML = "";

  const cooking = orders
    .filter(o => o.status === "COOKING")
    .sort((a,b) => (b.createdAtMs||0) - (a.createdAtMs||0));

  for (const o of cooking){
    const tile = document.createElement("div");
    tile.className = "tile";

    const linesHtml = (o.lines || []).map(l =>
      `<div class="row"><span>${l.qty}× ${l.name}</span><span>${money(l.price*l.qty)}</span></div>`
    ).join("");

    tile.innerHTML = `
      <div class="row">
        <div style="font-weight:900;font-size:18px;">Order #${o.number}</div>
        <button class="primary" style="width:auto;padding:10px 12px;" onclick="markReady('${o.id}', ${o.number})">✅</button>
      </div>
      <div class="tiny" style="margin-top:6px;">Tap to expand</div>
      <div id="cook-details-${o.id}" class="hidden" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
        ${linesHtml}
        <div class="row"><strong>Total</strong><strong>${money(o.total)}</strong></div>
      </div>
    `;

    tile.onclick = (ev) => {
      if (ev.target && ev.target.tagName === "BUTTON") return;
      const d = $("cook-details-" + o.id);
      d.classList.toggle("hidden");
    };

    list.appendChild(tile);
  }
}

async function markReady(orderId, orderNumber){
  if (!db) return;
  if (!confirm("Mark Order #" + orderNumber + " as READY?")) return;
  await db.collection("orders").doc(orderId).set({
    status: "READY",
    readyAtMs: Date.now(),
    readyAt: F.serverTimestamp()
  }, { merge: true });
  msg("Order #" + orderNumber + " READY ✅");
}

function renderCashierReady(){
  const list = $("cashierReadyList");
  const empty = $("cashierReadyEmpty");
  list.innerHTML = "";

  const ready = orders
    .filter(o => o.status === "READY")
    .sort((a,b) => (b.readyAtMs||0) - (a.readyAtMs||0));

  if (ready.length === 0){
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  for (const o of ready){
    const tile = document.createElement("div");
    tile.className = "tile";

    const linesHtml = (o.lines || []).map(l =>
      `<div class="row"><span>${l.qty}× ${l.name}</span><span>${money(l.price*l.qty)}</span></div>`
    ).join("");

    tile.innerHTML = `
      <div class="row">
        <div style="font-weight:900;font-size:18px;">Order #${o.number}</div>
        <button class="primary" style="width:auto;padding:10px 12px;" onclick="markTaken('${o.id}', ${o.number})">✅</button>
      </div>
      <div class="tiny" style="margin-top:6px;">Tap to expand • ✅ = Taken</div>
      <div id="ready-details-${o.id}" class="hidden" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
        ${linesHtml}
        <div class="row"><strong>Total</strong><strong>${money(o.total)}</strong></div>
        <div class="tiny">Paid ${money(o.paid)} • Change ${money(o.change)}</div>
      </div>
    `;

    tile.onclick = (ev) => {
      if (ev.target && ev.target.tagName === "BUTTON") return;
      const d = $("ready-details-" + o.id);
      d.classList.toggle("hidden");
    };

    list.appendChild(tile);
  }
}

async function markTaken(orderId, orderNumber){
  if (!db) return;
  if (!confirm("Mark Order #" + orderNumber + " as TAKEN?")) return;
  await db.collection("orders").doc(orderId).set({
    status: "PICKED_UP",
    pickedUpAtMs: Date.now(),
    pickedUpAt: F.serverTimestamp()
  }, { merge: true });
  msg("Order #" + orderNumber + " picked up ✅");
}

function renderHistory(){
  const list = $("historyList");
  list.innerHTML = "";

  const sorted = [...orders].sort((a,b) => (b.createdAtMs||0) - (a.createdAtMs||0));

  for (const o of sorted){
    const tile = document.createElement("div");
    tile.className = "tile";

    const linesHtml = (o.lines || []).map(l =>
      `<div class="row"><span>${l.qty}× ${l.name}</span><span>${money(l.price*l.qty)}</span></div>`
    ).join("");

    tile.innerHTML = `
      <div class="row">
        <div>
          <div style="font-weight:900">Order #${o.number} <span class="tiny">(${o.status})</span></div>
          <div class="tiny">Total ${money(o.total)} • Paid ${money(o.paid)} • Change ${money(o.change)}</div>
        </div>
        <button class="ghost" style="width:auto;" onclick="toggleHist('${o.id}')">Details</button>
      </div>
      <div id="hist-details-${o.id}" class="hidden" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
        ${linesHtml}
      </div>
    `;

    list.appendChild(tile);
  }
}

function toggleHist(orderId){
  const d = $("hist-details-" + orderId);
  if (d) d.classList.toggle("hidden");
}

/***********************
 * RESET DAY (delete all orders + reset counter)
 ***********************/
async function resetDay(){
  if (!db) return alert("Not connected to Firebase.");

  if (!confirm("⚠️ RESET DAY will delete ALL orders and reset order numbers to 1.\n\nAre you absolutely sure?")) return;

  try {
    // Delete all orders
    const snap = await db.collection("orders").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));

    // Reset counter
    const counterRef = db.collection("meta").doc("counters");
    batch.set(counterRef, { nextOrderNumber: 1 }, { merge: true });

    await batch.commit();
    msg("Day reset complete ✅");
    alert("All orders cleared. Order numbers reset to 1.");
  } catch (e) {
    console.error(e);
    alert("Reset failed. Check connection or rules.");
    msg("Reset failed ❌");
  }
}

/***********************
 * FIRESTORE LIVE SYNC
 ***********************/
function startSync(){
  db.collection("items").orderBy("createdAtMs", "asc").onSnapshot(
    (snap) => {
      items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderMenu();
      renderAdmin();
      renderCart();
    },
    (err) => {
      console.error(err);
      setConn("Items sync error ❌");
      msg(String(err.message || err));
    }
  );

  db.collection("orders").orderBy("createdAtMs", "desc").onSnapshot(
    (snap) => {
      orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderCook();
      renderCashierReady();
      renderHistory();
    },
    (err) => {
      console.error(err);
      setConn("Orders sync error ❌");
      msg(String(err.message || err));
    }
  );

  setConn("Connected ✅ (live sync)");
  msg("Sync started");
}

/***********************
 * BOOT
 ***********************/
(function boot(){
  msg("Booting…");

  try {
    if (!window.firebase) {
      setConn("Firebase CDN blocked ❌");
      msg("Network blocked gstatic.com (Firebase CDN).");
      return;
    }
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    F = firebase.firestore.FieldValue;

    startSync();

    renderMenu();
    renderCart();
    renderCook();
    renderCashierReady();
    renderHistory();

    setConn("Connecting…");
    setTimeout(() => {
      if ($("connStatus").textContent === "Connecting…") setConn("Connected ✅ (live sync)");
    }, 800);
  } catch (e) {
    console.error(e);
    setConn("Firebase init error ❌");
    msg(String(e.message || e));
  }
})();
</script>
</body>
</html>
